<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Statistiche Clienti e Servizi</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial, sans-serif; background-color: #fdfaf6; color: #333; padding: 20px; }
        h1 { text-align: center; margin-bottom: 30px; }
        .filters { display: flex; justify-content: center; gap: 15px; margin-bottom: 30px; }
        .chart-container { width: 80%; margin: 0 auto 50px auto; }
    </style>
</head>
<body>

<h1>Statistiche Clienti e Servizi</h1>

<div class="filters">
    <label>Periodo:
        <select id="periodo">
            <option value="mese">Mese</option>
            <option value="trimestre">Trimestre</option>
            <option value="anno">Anno</option>
        </select>
    </label>
</div>

<div class="chart-container">
    <canvas id="clientiAssiduiChart"></canvas>
</div>

<div class="chart-container">
    <canvas id="serviziRichiestiChart"></canvas>
</div>

<script>
    // Creazione dei grafici Chart.js
    const ctxClienti = document.getElementById('clientiAssiduiChart').getContext('2d');
    const ctxServizi = document.getElementById('serviziRichiestiChart').getContext('2d');

    const clientiAssiduiChart = new Chart(ctxClienti, {
        type: 'bar',
        data: { labels: [], datasets: [{ label: 'Visite', data: [], backgroundColor: '#f7c873' }] },
        options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
    });

    const serviziRichiestiChart = new Chart(ctxServizi, {
        type: 'pie',
        data: { labels: [], datasets: [{ label: 'Richieste', data: [], backgroundColor: ['#f7c873', '#c2d6d6', '#f2e6d9', '#d9c2c2'] }] },
        options: { responsive: true }
    });

    // Funzione per aggiornare grafici dai dati del backend
    async function aggiornaGrafici(periodo = 'mese') {
        // Clienti più assidui
        const clientiRes = await fetch(`/statistiche/clienti-assidui?periodo=${periodo}`);
        const clientiData = await clientiRes.json();
        clientiAssiduiChart.data.labels = clientiData.map(c => c.cliente_nome);
        clientiAssiduiChart.data.datasets[0].data = clientiData.map(c => c.visite);
        clientiAssiduiChart.update();

        // Servizi più richiesti
        const serviziRes = await fetch(`/statistiche/servizi-richiesti?periodo=${periodo}`);
        const serviziData = await serviziRes.json();
        serviziRichiestiChart.data.labels = serviziData.map(s => s.servizio);
        serviziRichiestiChart.data.datasets[0].data = serviziData.map(s => s.richieste);
        serviziRichiestiChart.update();
    }

    // Gestione filtro periodo
    document.getElementById('periodo').addEventListener('change', (e) => {
        aggiornaGrafici(e.target.value);
    });

    // Aggiorna grafici al caricamento pagina
    window.onload = () => aggiornaGrafici();
</script>

</body>
</html>

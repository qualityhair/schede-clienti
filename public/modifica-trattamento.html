<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Modifica Trattamento - QualityHair</title>
    <link rel="icon" href="/favicon.ico" type="image/x-icon" />
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Stili generali coerenti con il tema giallo e nero */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1a1a; /* Sfondo nero molto scuro */
            color: #fefefe; /* Testo bianco */
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 1rem;
            box-sizing: border-box;
        }

        .container {
            background-color: #ffcc00; /* Giallo brillante per il container principale */
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            padding: 2.5rem;
            width: 100%;
            max-width: 600px; /* Larghezza massima per il form */
            margin-top: 20px;
            color: #1a1a1a; /* Testo nero sul container giallo */
        }

        h1 {
            color: #1a1a1a;
            text-align: center;
            margin-bottom: 2rem;
            font-size: 2.5rem; /* Dimensione del titolo */
            font-weight: bold;
        }

        /* Stili per il form */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #1a1a1a;
        }

        .input-field, .select-field, .textarea-field {
            border: 1px solid #333333;
            border-radius: 8px;
            padding: 0.75rem 1rem;
            width: 100%;
            box-sizing: border-box;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
            color: #1a1a1a;
            background-color: #fefefe;
        }
        .input-field:focus, .select-field:focus, .textarea-field:focus {
            border-color: #ff9900;
            outline: none;
            box-shadow: 0 0 0 3px rgba(255, 153, 0, 0.3);
        }

        /* Stili specifici per textarea */
        .textarea-field {
            min-height: 100px;
            resize: vertical;
        }

        /* Stili per i bottoni */
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            width: 100%;
        }

        .btn-primary {
            background-color: #1a1a1a; /* Nero */
            color: #ffcc00; /* Giallo */
            border: none;
        }
        .btn-primary:hover {
            background-color: #333333;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background-color: #6c757d; /* Grigio */
            color: white;
            border: none;
        }
        .btn-secondary:hover {
            background-color: #5a6268;
            transform: translateY(-1px);
        }
        
        /* MODALE PERSONALIZZATA (copiata da lista-clienti.html) */
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .modal.open {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background-color: #fff;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 400px;
            text-align: center;
            color: #1a1a1a;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .modal-button {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease;
        }

        .modal-button.confirm {
            background-color: #dc3545;
            color: white;
            border: none;
        }
        .modal-button.confirm:hover {
            background-color: #bd2130;
        }

        .modal-button.cancel {
            background-color: #6c757d;
            color: white;
            border: none;
        }
        .modal-button.cancel:hover {
            background-color: #5a6268;
        }
        
        .modal-button.ok {
            background-color: #1a1a1a;
            color: #ffcc00;
            border: none;
        }
        .modal-button.ok:hover {
            background-color: #333333;
        }

        /* Responsive per il container del form */
        @media (max-width: 480px) {
            .container {
                padding: 1.5rem;
                border-radius: 8px;
                box-shadow: none;
            }
            h1 {
                font-size: 2rem;
            }
            .input-field, .select-field, .textarea-field, .btn {
                padding: 0.75rem;
            }
        }
    </style>
</head>
<body>
    <!-- Rimosso: div id="navbar" e script src="/js/navbar-loader.js" -->

    <main class="container">
        <h1 id="pageTitle">Modifica Trattamento</h1>
        <form id="form-modifica-trattamento" class="flex flex-col">
            <div class="form-group">
                <label for="tipo_trattamento" class="form-label">Tipo Trattamento</label>
                <select id="tipo_trattamento" name="tipo_trattamento" class="select-field" required>
                    <option value="">Seleziona un tipo di trattamento</option>
                    <option value="Colore">Colore</option>
                    <option value="Trattamento">Trattamento</option>
                    <option value="Meches">Meches</option>
                    <option value="Permanente">Permanente</option>
                    <option value="Taglio">Taglio</option>
                    <option value="Piega">Piega</option>
                    <option value="Manicure">Manicure</option>
                    <option value="Pedicure">Pedicure</option>
                    <option value="Acconciatura">Acconciatura</option>
                    <option value="Barba">Barba</option>
                    <option value="Altro">Altro</option>
                </select>
            </div>
            <div class="form-group">
                <label for="descrizione" class="form-label">Descrizione</label>
                <textarea id="descrizione" name="descrizione" class="textarea-field" placeholder="Descrizione del trattamento" required></textarea>
            </div>
            <div class="form-group">
                <label for="data_trattamento" class="form-label">Data Trattamento</label>
                <input type="date" id="data_trattamento" name="data_trattamento" class="input-field" required />
            </div>
            <div class="form-group">
                <label for="note" class="form-label">Note</label>
                <textarea id="note" name="note" class="textarea-field" placeholder="Note aggiuntive"></textarea>
            </div>
            <button type="submit" class="btn btn-primary">Salva Modifiche</button>
            <button type="button" id="backToSchedaBtn" class="btn btn-secondary mt-4">Annulla e Torna</button>
        </form>
    </main>

    <!-- Modale personalizzata per alert e confirm -->
    <div id="customModal" class="modal">
        <div class="modal-content">
            <p id="modalMessage" class="text-lg mb-4"></p>
            <div id="modalButtons" class="modal-buttons">
                <!-- I bottoni saranno aggiunti qui via JS -->
            </div>
        </div>
    </div>

    <script>
        // Riferimenti al DOM della modale
        const customModal = document.getElementById('customModal');
        const modalMessage = document.getElementById('modalMessage');
        const modalButtons = document.getElementById('modalButtons');

        function showCustomModal(message, type = 'alert', onConfirmCallback = null) {
            modalMessage.textContent = message;
            modalButtons.innerHTML = '';

            if (type === 'confirm') {
                const confirmBtn = document.createElement('button');
                confirmBtn.textContent = 'Conferma';
                confirmBtn.className = 'modal-button confirm';
                confirmBtn.onclick = () => {
                    customModal.classList.remove('open');
                    if (onConfirmCallback) onConfirmCallback(true);
                };
                modalButtons.appendChild(confirmBtn);

                const cancelBtn = document.createElement('button');
                cancelBtn.textContent = 'Annulla';
                cancelBtn.className = 'modal-button cancel';
                cancelBtn.onclick = () => {
                    customModal.classList.remove('open');
                    if (onConfirmCallback) onConfirmCallback(false);
                };
                modalButtons.appendChild(cancelBtn);
            } else {
                const okBtn = document.createElement('button');
                okBtn.textContent = 'OK';
                okBtn.className = 'modal-button ok';
                okBtn.onclick = () => {
                    customModal.classList.remove('open');
                    if (onConfirmCallback) onConfirmCallback();
                };
                modalButtons.appendChild(okBtn);
            }
            customModal.classList.add('open');
        }

        function redirectTo(path) {
            window.location.href = path;
        }

        // --- Logica della Pagina Modifica Trattamento ---
        const formModificaTrattamento = document.getElementById('form-modifica-trattamento');
        const tipoTrattamentoSelect = document.getElementById('tipo_trattamento');
        const descrizioneTextarea = document.getElementById('descrizione');
        const dataTrattamentoInput = document.getElementById('data_trattamento');
        const noteTextarea = document.getElementById('note');
        const pageTitle = document.getElementById('pageTitle');
        const backToSchedaBtn = document.getElementById('backToSchedaBtn');

        let trattamentoId = null;
        let clienteId = null; // Sarà utile per tornare alla scheda cliente

        document.addEventListener('DOMContentLoaded', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            trattamentoId = urlParams.get('id');

            if (trattamentoId) {
                await fetchTrattamentoDetails(trattamentoId);
            } else {
                showCustomModal('ID Trattamento mancante nell\'URL. Non è possibile modificare il trattamento.', 'error', () => {
                    redirectTo('/lista-clienti.html'); // Reindirizza alla lista clienti se l'ID è mancante
                });
            }

            // Imposta l'onclick per il bottone Annulla/Torna
            if (backToSchedaBtn) {
                backToSchedaBtn.onclick = () => {
                    // Se abbiamo l'ID del cliente, torniamo alla sua scheda, altrimenti alla lista
                    if (clienteId) {
                        redirectTo(`/scheda-cliente.html?id=${clienteId}`);
                    } else {
                        redirectTo('/lista-clienti.html');
                    }
                };
            }
        });

        // Recupera i dettagli di un singolo trattamento per precompilare il form
        async function fetchTrattamentoDetails(id) {
            try {
                const response = await fetch(`/api/trattamenti/${id}`); 
                
                if (response.status === 401) {
                    showCustomModal('Sessione scaduta o non autorizzato. Effettua nuovamente il login.', 'alert', () => {
                        redirectTo('/');
                    });
                    return;
                }
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Errore HTTP: ${response.status} - ${errorText}`);
                }
                const trattamento = await response.json();
                if (trattamento) {
                    // Precompila il form
                    tipoTrattamentoSelect.value = trattamento.tipo_trattamento || '';
                    descrizioneTextarea.value = trattamento.descrizione || '';
                    dataTrattamentoInput.value = trattamento.data_trattamento ? new Date(trattamento.data_trattamento).toISOString().split('T')[0] : '';
                    noteTextarea.value = trattamento.note || '';

                    // Memorizza l'ID del cliente per il reindirizzamento
                    clienteId = trattamento.cliente_id;
                    pageTitle.textContent = `Modifica Trattamento per ${trattamento.tipo_trattamento}`; // Aggiorna il titolo della pagina
                    
                    // Aggiorna anche il testo del bottone "Annulla e Torna"
                    if (clienteId) {
                        const clientResponse = await fetch(`/api/clienti/${clienteId}`);
                        if (clientResponse.ok) {
                            const clientData = await clientResponse.json();
                            if (clientData && clientData.nome && clientData.cognome) {
                                backToSchedaBtn.textContent = `Annulla e Torna alla scheda di ${clientData.nome} ${clientData.cognome}`;
                            }
                        }
                    }

                } else {
                    showCustomModal('Trattamento non trovato.', 'alert', () => {
                        redirectTo('/lista-clienti.html');
                    });
                }
            } catch (error) {
                console.error('Errore nel recupero dettagli trattamento:', error);
                showCustomModal(`Errore nel caricamento dei dettagli del trattamento: ${error.message}`, 'error', () => {
                     redirectTo('/lista-clienti.html'); // Torna alla lista se errore grave
                });
            }
        }

        // Gestione submit del form per modificare trattamento
        formModificaTrattamento.addEventListener('submit', async (event) => {
            event.preventDefault();

            const updatedTreatment = {
                tipo_trattamento: tipoTrattamentoSelect.value,
                descrizione: descrizioneTextarea.value,
                data_trattamento: dataTrattamentoInput.value,
                note: noteTextarea.value
            };

            if (!updatedTreatment.tipo_trattamento || !updatedTreatment.data_trattamento) {
                showCustomModal('Tipo Trattamento e Data Trattamento sono obbligatori.', 'error');
                return;
            }

            try {
                const response = await fetch(`/api/trattamenti/${trattamentoId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(updatedTreatment),
                });

                if (response.status === 401) {
                    showCustomModal('Sessione scaduta o non autorizzato. Effettua nuovamente il login.', 'alert', () => {
                        redirectTo('/');
                    });
                    return;
                }

                if (!response.ok) {
                    const errorData = await response.json();
                    // Non sollevare un nuovo errore qui, gestiscilo direttamente
                    showCustomModal(`Errore nell'aggiornamento del trattamento: ${errorData.message || 'Errore sconosciuto.'}`, 'error');
                    return; // Interrompi l'esecuzione
                }

                const successData = await response.json();
                showCustomModal(successData.message || 'Trattamento aggiornato con successo!', 'success', () => {
                    if (clienteId) {
                        redirectTo(`/scheda-cliente.html?id=${clienteId}`);
                    } else {
                        redirectTo('/lista-clienti.html');
                    }
                });

            } catch (error) {
                console.error('Errore durante l\'aggiornamento del trattamento:', error);
                showCustomModal(`Errore di rete o server: ${error.message}`, 'error');
            }
        });
    </script>
    
</body>
</html>